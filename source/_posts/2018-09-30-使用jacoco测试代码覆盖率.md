---
title: 使用jacoco测试代码覆盖率
date: 2018-09-30 16:24:27
tags:
- java
- jacoco
categories:
- java
thumbnail: http://image.candymami.com/18-10-8/75310010.jpg!blogtitle
permalink: Test-Coverage-Of-Web-Project-Code-Using-Jacoco
---

使用jacoco测试web项目代码的覆盖率
====

### 远程执行配置篇

#### 下载JACOCO

官网：[EclEmma](https://www.eclemma.org/jacoco/)
下载地址，V0.8.2：[jacoco-0.8.2.zip](http://search.maven.org/remotecontent?filepath=org/jacoco/jacoco/0.8.2/jacoco-0.8.2.zip)

下载完成后，解压缩就可以，配置时，我们需要lib文件夹下的jacocoagent.jar和jacococli.jar文件。

#### 增加tomcat配置

- 关闭现在的tomcat服务 `./shutdown.sh`

- 在`catalina.sh`中第二行增加内容：

linux: `JAVA_OPTS="-javaagent:/home/hanz/jacocotest/jacoco/lib/jacocoagent.jar=includes=com.*,output=tcpserver,port=9527,address=10.168.136.46,append=true -Xverify:none"`

windows: `set JAVA_OPTS="-javaagent:/home/hanz/jacocotest/jacoco/lib/jacocoagent.jar=includes=com.*,output=tcpserver,port=9527,address=10.168.136.46,append=true -Xverify:none"`

参数说明：
1. yourPath 是放 jacocoagent.jar 文件的目录路径；那么 `jacocoagent.jar` 这个 `jar` 包的路径就是在准备工作里下载下来的 `zip` 包，解压之后的 `lib` 目录下。
2. includes 是指要收集哪些类（注意不要光写包名，最后要写.*)，不写的话默认是*，会收集应用服务上所有的类，包括服务器和其他中间件的类，一般要过滤（当然如果你愿意写*也完全没有问题，如：`includes=com.*` or `includes=*`）；
3. output 有 4 个值，分别是 file、tcpserver、tcpclient、mbean，默认是 file。使用 file 的方式只有在停掉应用服务的时候才能产生覆盖率文件，而使用 tcpserver 的方式可以在不停止应用服务的情况下下载覆盖率文件，后面会介绍如何使用 dump 方法来得到覆盖率文件。
4. address 是 IP 地址，IP 就是 Tomcat 服务器的机器的 IP，至于是写 `服务器本机的 IP` 还是写 `127.0.0.1` 要看情况 1) 如果是在 Tomcat 服务器上执行 `ant dump` 的话，就直接写 `address=127.0.0.1` 2) 如果执行 `ant dump` 不是在 Tomcat 服务器上执行的，就得写服务器本机的IP（切记）
5. port 是端口（端口比较随便，找个能用的端口就行，直接我为什么将端口写成 `8044`，我的想法是 `BUG 死死` 与 `8044` 挺配的，所以就用它作为端口号了） （`address` 和 `port` 是使用 tcpserver 方式需要的 2 个参数，也是执行 ant dump 方法必须要用到的。）
6. `-Xverify:none`：这个参数是防止启动主程序异常才加的（非强制，可以不加）
更多jacocoagent.jar的参数详见官网：[jacocoagent.jar参数](http://www.eclemma.org/jacoco/trunk/doc/agent.html)

- 重新启动tomcat，`./startup.sh`

- 验证JAVA_OPTS是否加载：

Linux下载终端窗口中输入`ps -ef | grep tomcat`

Windows下在cmd窗口使用WMIC命令，回车
回显：`wmic:root\cli>`
在>后面输入：`process where name="java.exe"`命令
查看回显信息

#### 编写jacocoAnt.xml文件

有现成的模板来参考：

```xml
<?xml version="1.0" ?>
<project name="Lengyu" xmlns:jacoco="antlib:org.jacoco.ant" default="jacoco">
    <!--Jacoco的安装路径-->
  <property name="jacocoantPath" value="/home/work/software/jacoco_0.6.4/lib/jacocoant.jar"/>
  <!--最终生成.exec文件的路径，Jacoco就是根据这个文件生成最终的报告的-->
  <property name="jacocoexecPath" value="/home/work/local/hudson_home/workspace/wg_merchant_oc_regression/jacoco.exec"/>
    <!--生成覆盖率报告的路径-->
  <property name="reportfolderPath" value="E:/Libs/coverage_ant_task/report/"/>
  <!--远程tomcat服务的ip地址-->
  <property name="server_ip" value="10.81.14.77"/>
  <!--前面配置的远程tomcat服务打开的端口，要跟上面配置的一样-->
  <property name="server_port" value="8893"/>
  <!--源代码路径-->
  <property name="checkOrderSrcpath" value="E:/Src/ordercenter/ordercenter-biz/src/main/java/" />
  <!--.class文件路径-->
  <property name="checkOrderClasspath" value="E:/Src/ordercenter/ordercenter-biz/target/classes/com/baidu/ordercenter/service/Impl" />

  <!--让ant知道去哪儿找Jacoco-->
  <taskdef uri="antlib:org.jacoco.ant" resource="org/jacoco/ant/antlib.xml">
      <classpath path="${jacocoantPath}" />
  </taskdef>

  <!--dump任务:
      根据前面配置的ip地址，和端口号，
      访问目标tomcat服务，并生成.exec文件。-->
  <target name="dump">
      <jacoco:dump address="${server_ip}" reset="false" destfile="${jacocoexecPath}" port="${server_port}" append="true"/>
  </target>
  
  <!--jacoco任务:
      根据前面配置的源代码路径和.class文件路径，
      根据dump后，生成的.exec文件，生成最终的html覆盖率报告。-->
  <target name="report">
      <delete dir="${reportfolderPath}" />
      <mkdir dir="${reportfolderPath}" />
      
      <jacoco:report>
          <executiondata>
              <file file="${jacocoexecPath}" />
          </executiondata>
              
          <structure name="JaCoCo Report">
              <group name="Check Order related">           
                  <classfiles>
                      <fileset dir="${checkOrderClasspath}" />
                  </classfiles>
                  <sourcefiles encoding="gbk">
                      <fileset dir="${checkOrderSrcpath}" />
                  </sourcefiles>
              </group>
          </structure>

          <html destdir="${reportfolderPath}" encoding="utf-8" />         
      </jacoco:report>
  </target>
</project>
```
#### 执行并查看报告

执行编写好的jacocoAnt.xml

`ant -f jacocoAnt.xml`

生成报告的路径在配置的xml文件里标明。

### 部署

后期可配合Jenkins做可视化图表，在这里不表。

### 参考资料

[jacoco + ant远程统计（tomcat/spring boot）服务的代码覆盖率](https://www.cnblogs.com/dingtian/p/7754079.html)
[JaCoCo在Tomcat服务器上监控代码覆盖率的使用方法](https://www.cnblogs.com/wozijisun/p/9667849.html)
[Jacoco远程统计tomcat服务（Windows系统）的代码覆盖率](https://www.cnblogs.com/Ming8006/p/7569231.html)
[代码覆盖率在手工测试上的实践](https://blog.163yun.com/blog/article/173245675491745792)
